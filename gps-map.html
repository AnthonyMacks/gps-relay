<!DOCTYPE html>
<html>
<head>
  <title>Live GPS Tracker</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .device-label {
      background: transparent;
      color: #154360;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      font-size: 11px;
    }
    .arrow-icon {
      color: #2874A6;
      font-weight: bold;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-33.87, 151.21], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    const socket = io(); // Assumes same host; use full URL if needed
    const gpsTrail = [];
    let lastPoint = null;

    function addLabeledCircle(point) {
      const lat = parseFloat(point.latitude);
      const lon = parseFloat(point.longitude);

      L.circleMarker([lat, lon], {
        radius: 12,
        color: '#2E86C1',
        fillColor: '#AED6F1',
        fillOpacity: 0.9,
        weight: 2
      }).addTo(map);

      const label = L.divIcon({
        html: `<div>${point.device_id}</div>`,
        className: 'device-label',
        iconSize: [24, 24]
      });

      L.marker([lat, lon], { icon: label, interactive: false }).addTo(map);
    }

    function addTrail(point) {
      const lat = parseFloat(point.latitude);
      const lon = parseFloat(point.longitude);
      gpsTrail.push([lat, lon]);

      if (gpsTrail.length > 100) gpsTrail.shift();

      L.polyline(gpsTrail, {
        color: '#1ABC9C',
        weight: 3,
        opacity: 0.7
      }).addTo(map);
    }

    function addArrow(p1, p2) {
      const latMid = (parseFloat(p1.latitude) + parseFloat(p2.latitude)) / 2;
      const lonMid = (parseFloat(p1.longitude) + parseFloat(p2.longitude)) / 2;

      const angleRad = Math.atan2(
        parseFloat(p2.longitude) - parseFloat(p1.longitude),
        parseFloat(p2.latitude) - parseFloat(p1.latitude)
      );
      const angleDeg = angleRad * (180 / Math.PI);

      const arrowIcon = L.divIcon({
        html: `<div style="transform: rotate(${angleDeg}deg);">‚û§</div>`,
        className: 'arrow-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      L.marker([latMid, lonMid], { icon: arrowIcon, interactive: false }).addTo(map);
    }

    socket.on("gps_update", (data) => {
      if (!data.latitude || !data.longitude || !data.device_id) return;

      addLabeledCircle(data);

      if (lastPoint) {
        addTrail(data);
        addArrow(lastPoint, data);
      }

      lastPoint = data;
      console.log(`üìç ${data.device_id} ‚Üí (${data.latitude}, ${data.longitude})`);
    });
  </script>
</body>
</html>
